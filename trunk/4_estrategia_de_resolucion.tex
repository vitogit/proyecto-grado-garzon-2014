\chapter{Estrategia de resolución}

Este capítulo explica la estrategia de resolución seguida para resolver el problema de sincronización de semáforos en el Corredor Garzón. La metodología se basa en tres puntos: el modelado del problema, el algoritmo evolutivo desarrollado y el uso de técnicas de alto desempeño. El capítulo comienza presentando el modelado del problema, que incluye el diseño del mapa de la zona y la creación de instancias realistas que serán usadas para simular el tráfico en el simulador SUMO. En esta primera sección se presenta el simulador de tráfico SUMO y el trabajo de campo realizado para recabar datos precisos de la realidad. Luego el capítulo detalla el diseño e implementación del algoritmo evolutivo multiobjetivo, que fue desarrollado utilizando la biblioteca Malva. Finalmente se especifican los parámetros, características y modelo de paralelismo del Algoritmo Evolutivo implementado.


\section{Modelado del problema }

El modelado del problema comprende la simplificación de la realidad y el uso de aquellos elementos que resulten útiles para resolver el problema de sincronización de semáforos. El modelado se basa en el diseño de un mapa de la zona e instancias realistas que serán usadas en el simulador de tráfico SUMO. A continuación se presenta el simulador, las herramientas necesarias utilizadas y el proceso seguido para desarrollar el modelo. 

\subsection{Simulador SUMO (Simulation of Urban MObility)}

Como se explicó en el marco teórico, SUMO es un simulador de tráfico gratuito y de código abierto que permite modelar redes de calles, vehículos, transporte público, ciudadanos y semáforos. Este simulador sigue un modelo microscópico, ya que realiza la simulación individual explícita de cada elemento. SUMO incluye un conjunto de herramientas destinadas a facilitar la generación de tráfico y la construcción de mapas. 

Puesto que existe un amplio abanico de posibilidades a la hora de elegir un simulador de tráfico, se efectuó un análisis relacionado con las posibilidades y objetivos del proyecto. A continuación se presentan las razones que sustentan la elección de SUMO como el simulador de tráfico utilizado:

\begin{itemize}
	\item Portable: SUMO puede ser ejecutado tanto en Windows como en Linux. Esta característica es requerida, dado que Windows es una de las plataformas utilizadas para implementar el proyecto y Linux (CentOs) es el sistema operativo utilizada por el Cluster Fing donde se desarrolla el análisis experimental.
	
	\item Modos de ejecución: SUMO puede ejecutarse sin interfaz gráfica, utilizando solamente la línea de comando, lo que aumenta sensiblemente la velocidad de ejecución. Esta funcionalidad es fundamental a la hora de diseñar el algoritmo evolutivo, ya que la interacción con el simulador de tráfico debe ser eficiente. Por otro lado, presenta la opción de ejecutarse con interfaz gráfica, lo que es indispensable a la hora de visualizar la simulación. Esta opción es útil sobre todo en el inicio del desarrollo, cuando se realizan ajustes y pruebas.
	
	\item Gratuito y abierto: SUMO se presenta como un proyecto de código abierto y sin costo, siendo un factor importante para un proyecto de investigación como el que se quiere desarrollar. 
	
	\item Documentación y mantenimiento: Este simulador incluye una detallada documentación que hace más fácil su utilización. Cuenta con una comunidad muy activa que responde dudas en foros lo cual es útil a la hora de buscar soporte en caso de problemas o errores. SUMO también cuenta con un desarrollo activo que permite su mejora por medio de actualizaciones frecuentemente.
	
	\item Configuración simple: SUMO presenta un sencillo sistema de configuración, basada en archivos XML para la ejecución de las simulaciones. La modificación de estos archivos permiten alterar la configuración de los semáforos, las propiedades y rutas de los vehículos, entre otras opciones. Complementariamente cuenta con herramientas para importar mapas de servicios como OSM \citep{OSM}.
	
	\item Información de salida: SUMO ofrece la opción de generar una amplia variedad de datos, producida por la simulación ejecutada. Entre estos datos se encuentran la velocidad de los vehículos y el largo del recorrido, datos que son requeridos por la solución propuesta.
	
	\item Eficiente: Soporta redes de tránsito muy grandes y está diseñado para ejecutar simulaciones a gran velocidad, siendo una característica deseable por la complejidad del problema a solucionar.
	
\end{itemize}


SUMO presenta un funcionamiento sencillo basado en tomar como entradas archivos de configuración que representan la red vial, los vehículos, el tráfico y los semáforos. Además, genera archivos de salida con información útil como el tiempo de simulación, la cantidad de vehículos, velocidad de los vehículos, duración del viaje, emisiones de gases contaminantes, etc. 

Dada la complejidad del problema a enfrentar, se utilizan otras herramientas para realizar ciertas tareas de manera más eficiente y con menos errores. \emph{NetConvert} viene integrado con SUMO y es utilizado para generar la red vial a partir del mapa obtenido de Open Street Map, transformándolo al formato que SUMO reconoce. Otra herramienta integrada con SUMO es \emph{DUaRouter} que permite generar recorridos de vehículos basado en dinámicas definidas por el usuario. \emph{Traffic Modeler} creado por \citet{TrafficModeler}, es útil para la generación de tráfico de manera visual que puede ser exportado al formato reconocido por SUMO. 
	


\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\linewidth]{Figures/sim1}
	\caption[Simulación de trafico en el simulador SUMO.]{Simulación de tráfico en el simulador SUMO en el cruce entre Bulevar Battle y Ordoñez y el Corredor Garzón.}
	\label{fig:sim1}
\end{figure}



\subsection{Proceso de modelado}

El objetivo del proceso de modelado es el desarrollo de instancias realistas del problema. Se comienza con el diseño del mapa que representa la zona del Corredor Garzón. Luego se describe el trabajo de campo realizado para obtener datos precisos de la realidad. Finalmente utilizando estos datos, se describe el desarrollo de las instancias realistas que serán utilizadas en el simulador de tráfico.

\subsubsection{Diseño del mapa}

El primer paso del modelado consiste en diseñar un mapa de la zona del Corredor Garzón que sea compatible con el simulador. El servicio de Open Street Map \citep{OSM} cuenta con mapas libres y actualizados por una comunidad muy activa. Este servicio se utiliza para importar la zona de interés y luego editarlo con el programa JOSM(Java OpenStreetMap Editor) para poder adecuarlo a las necesidades del problema.  Se utilizaron otros servicios (Google Maps y Bing Maps) y un estudio de la zona para validar la exactitud del mapa importado desde OSM. Algunas inconsistencias fueron detectadas entre la realidad y el mapa importado, las cuales fueron corregidas, por ejemplo en la dirección de las rutas y el diseño de algunos cruces.  

El alcance geográfico comprende al Corredor Garzón en toda su extensión y dos caminos paralelos a cada lado del mismo.
Como se ve en el mapa de la figura \ref{fig:mapa_osm_sumo}, no existen calles paralelas reales, por lo que el proceso para diseñar el mapa consistió en: seleccionar las calles que construyen dos caminos paralelos a cada lado del Corredor Garzón, luego, seleccionar las calles internas entre las paralelas. Se verifica que cada camino paralelo incluya calles doble mano o dos calles de una sola mano, finalmente se borran las demás calles que no están incluidas en la zona modelada.


Dado los cambios realizados en el mapa, como la eliminación de calles que no formaban parte de la zona modelada, no se pudo contribuir con la comunidad OSM subiendo el mapa con las modificaciones que corregían algunas inconsistencias encontradas.



\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\linewidth]{Figures/mapa_osm_sumo}
	\caption[Mapa del corredor Garzón]{Mapa del corredor Garzón. A la izquierda el mapa extraído de OSM, a la derecha el mapa procesado listo para ser usado en SUMO. El corredor Garzón está en el centro de cada imagen.}
	\label{fig:mapa_osm_sumo}
\end{figure}

La herramienta \emph{Netconvert} fue utilizada para transformar el mapa obtenido desde OSM, al formato XML que reconoce el simulador SUMO. Esta herramienta no reconoce algunos datos incluidos en el formato OSM, por ejemplo: los números de las casas, vías de tren, vías de peatones, caminos, plazas, paradas y los separadores que tiene el corredor de las vías para autos, entre otros. Se destaca como punto importante que NetConvert no reconoce correctamente a los corredores, ya que confunde y superpone el corredor central con las vías para los autos, seguramente por no reconocer los separadores físicos que presenta el corredor. Para solucionar este problema se utilizó el programa JOSM para eliminar los datos no reconocidos por NetConvert y editar el mapa, separando aproximadamente un metro las calles del corredor central. Esta modificación permitió que NetConvert interpretara correctamente el funcionamiento del corredor, para que los vehículos no se trasladaran entre la vía de los autos y la del corredor de ómnibus. Pero este cambio implementado generó un problema, ya que cada cruce de la realidad pasó a ser representado por tres cruces distintos (uno por cada calle del corredor). Para solucionar el problema anterior y otros errores, se realizaron ajustes manuales, modificando los archivos xml relacionados. Entre otros cambios, se especificó manualmente las reglas de movilidad correctas en algunos cruces, por ejemplo cuando estaba prohibido girar  a la izquierda.

Al finalizar el proceso de diseño, se obtuvo un mapa fiel a la realidad, delimitado en la zona del Corredor Garzón que es compatible con el simulador de tráfico SUMO.


\subsubsection{Trabajo de campo}

Existen datos públicos disponibles sobre la cantidad de ómnibus y sus frecuencias, pero no se tienen datos sobre la densidad del tráfico vehicular en la zona del Corredor Garzón. Por este motivo se realizó un revelamiento in-situ en cinco cruces representativos. Los cruces seleccionados fueron: Camino Ariel, Battle y Ordoñez, Plaza Videla, Camino Colman y Aparicio Saravia. Estos cruces presentan diferentes características que son útiles para modelar variantes en la cantidad de vehículos circulantes. 

Se siguieron las recomendaciones de los textos consultados relacionados con el conteo vehicular \citep{ConteoTrafico}. El día seleccionado para efectuar el conteo fué el miércoles, con clima soleado y en el horario de 15:00 a 17:00 horas, para no obtener sesgos que se producen los fines de semana, en horas pico, o en días de lluvia. Se realizaron filmaciones de entre 15 y 30 minutos en los cruces y luego se analizaron los vídeos para efectuar el conteo manual con la posibilidad de enlentecer el vídeo para mayor facilidad. Luego se completó una planilla electrónica (figura \ref{fig:conteo_hoja}) donde se incluyen: la cantidad de vehículos que recorren el Corredor Garzón, los que circulan por la calle que cruza y los que doblan. 

\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\linewidth]{Figures/conteo_hoja}
	\caption[Ejemplo de planilla electrónica para el conteo manual de tráfico.]{Ejemplo de planilla electrónica para el conteo manual de tráfico en la intersección entre el corredor Garzón y Camino Ariel}
	\label{fig:conteo_hoja}
\end{figure}



\begin{table}[H]
	\renewcommand{\arraystretch}{1.2}
	\caption[Resumen del revelamiento del tráfico en la zona del corredor Garzón.]{Resumen del revelamiento del tráfico en la zona del corredor Garzón. Se muestra la cantidad de vehículos y la orientación hacia donde circulan.}
	\label{table:resumen_trafico}
	\centering
	\begin{tabular}{lcccc}
		\hline
		Intersección&
		Sur-Garzón& 
		Norte-Garzón & 
		Oeste &
		Este 
		\\ 
		\hline
		Camino Colman  & 410 & 390 & 140 & 230\\		
		Plaza Vidiella  & 400 & 444 & 292 & 0\\		
		Aparicio Saravia  & 390 & 450 & 40 & 90\\		
		Battle y Ordoñez  & 510 & 390 & 470 & 300 \\	
		Camino Ariel  & 436 & 226 & 177 & 203 \\													
		\hline
		
		
		\hline
	\end{tabular}
\end{table}

La tabla \ref{table:resumen_trafico} muestra la cantidad de vehículos en los distintos cruces; hay que tener en cuenta que solamente se contabilizan los autos, no se tienen en cuenta otro tipo de vehículos.

Se realizaron recorridas de punta a punta del corredor a una velocidad constante en auto para ser utilizados como datos a la hora de desarrollar las simulaciones de tráfico. Con este análisis se obtiene tanto la duración total del recorrido, como el tiempo que permanece detenido en los cruces semaforizados. 

Para la configuración de los semáforos, se realizó un recorrido en bicicleta por toda la extensión del Corredor Garzón. Se cronometró la duración de las luces de los semáforos en cada esquina recorriendo el camino de ida, y para validar los tiempos también se relevaron las duraciones de las luces en el camino de vuelta. Estos tiempos fueron verificados por los vídeos obtenidos anteriormente en el conteo del tráfico.


\subsubsection{Desarrollo de instancias realistas del problema}

Una vez completado el diseño del mapa compatible con el simulador de la zona del Corredor Garzón,  y obtenidos los datos relevados de la realidad, se procede al desarrollo de instancias realistas que representen la situación actual en relación con el tráfico.

Existen varios modelos disponibles para representar la circulación de los vehículos. El modelo \emph{aleatorio} genera recorridos para los vehiculos al azar. En el modelo \emph{basado en áreas} se especifican las zonas donde el tráfico se origina y donde finaliza. Un modelo más complejo es el \emph{basado en actividad} donde se definen la cantidad de casas, vehículos y población de una zona determinada. Luego el modelo genera la densidad de tráfico basado en los tipos de actividades que se realizan comúnmente, como ir al trabajo, hacer las compras, ir a la escuela, etc. Finalmente un modelo muy utilizado, sobre todo en escenarios de tamaño reducido, es el \emph{definido por el usuario} que permiten determinar la ruta de cada vehículo con mayor detalle.

Se utilizó el programa Traffic Modeler \citep{TrafficModeler} que se caracteriza por generar modelos de tráfico complejos de manera visual. Se optó por un modelo de movilidad entre áreas, lo que permite una buena granularidad al especificar la densidad de tráfico. El programa genera el recorrido del viaje para cada vehículo, que se mantienen constantes en las distintas ejecuciones del algoritmo evolutivo. La variación se produce en las velocidades desarrolladas por cada uno, ya que dependiendo de la configuración de los semáforos logrará mayores o menores velocidades.



\begin{figure}[h]
	\centering
	\includegraphics[width=0.5\linewidth]{Figures/areaflow1}
	\caption[Mapa diseñado en el TrafficModeler para la generación de tráfico.]{Mapa diseñado en el TrafficModeler para la generación de trafico. Los círculos del mismo color especifican el tráfico entre esas áreas. }
	\label{fig:areaflow1}
\end{figure}


Se plantea el uso de dos tipos de vehículos: autos y ómnibus. Cada tipo de vehículo posee diferentes características asociadas, como el tamaño, aceleración y velocidad máxima. No se especifican otros tipos de vehículos como motos o camiones ya que el trabajo se enfoca en los dos primeros tipos. Se agregaron las frecuencias y los distintos recorridos de los ómnibus obtenidos de datos públicos de la Intendencia Municipal de Montevideo(IMM). Las frecuencias incluyen las líneas urbanas: 'G', '409' ,'2', 'd5'  y  '148'. Las líneas de ómnibus suburbanas realizan  un mismo  trayecto las cuales no van a ser tomadas en cuenta en la optimización del algoritmo pero si aparecerán en la simulación.

La ubicación y líneas de cada parada se obtuvo del Servicio de Información Geográfica de Montevideo (http://sig.montevideo.gub.uy). Existen 14 paradas de líneas urbanas por el Corredor Garzón para el recorrido de ida y la misma cantidad para la vuelta. Se realizaron variantes en los recorridos dentro de una misma línea para simular el hecho de que no siempre se detienen en las mismas paradas. Se tuvo en cuenta el tiempo que demora un ómnibus al detenerse en una parada y que existen paradas donde por la cantidad de pasajeros se demora más tiempo. La duración de la detención en las paradas fueron obtenidas en el lugar, con tiempos de entre 15 a 35 segundos.

Se realizó un estudio basado en datos de GPS proporcionados por la IMM. Estos datos cuentan con la posición exacta, la velocidad instantánea y la referencia del ómnibus, para un conjunto de líneas seleccionadas tomadas en un período de una semana. 
Para este procesamiento se utilizó QGIS, un sistema de información geográfico capaz de visualizar, editar y realizar operaciones sobre elementos geográficos. Adicionalmente fue necesario el desarrollo de \emph{scripts} para obtener las estadísticas necesarias, ya que la cantidad de información estudiada era muy grande (1.5Gb). El uso de QGIS permitió seleccionar, filtrar y relacionar los datos de posición y velocidad con las líneas que circulan por el Corredor Garzón. Luego de procesar los datos se constató una velocidad media de 14.5 km/h en el Corredor Garzón lo que permitió ajustar mejor el modelo. 

Para configurar la simulación del tráfico se utilizan como entrada tres archivos de configuración en formato XML que son reconocidos por el simulador SUMO. El primero, es el archivo de \emph{configuración de los semáforos} donde se detalla la duración de las luces, el comienzo de fase y la ubicación de los mismos en el mapa base. El segundo archivo representa la \emph{ruta de los vehículos} que contiene el recorrido de cada vehículo. Finalmente el archivo con el \emph{recorrido de los ómnibus} indica el recorrido de los mismos, su frecuencia, la ubicación de las paradas, en cuales se detienen y el tiempo que demoran en la parada.

Finalizando este proceso, se cuenta con todos los elementos necesarios para la creación de instancias realistas del problema, que serán utilizadas en el simulador para modelar la realidad. En el análisis experimental presentado en el próximo capítulo se describen los escenarios que hacen uso de estas instancias, modificando algunas variables como la densidad del tráfico para ajustarlo a las necesidades de la experimentación.


%REDACTAR: no me convence mucho el titulo
\section{Arquitectura de la solución}

El esquema de la figura \ref{fig:arquitectura1}  muestra la arquitectura propuesta para el problema. La biblioteca Malva se utiliza para la implementación del algoritmo evolutivo. En cada evaluación de la función de fitness se realiza un llamado al simulador SUMO. El primer paso consiste en generar la población inicial del algoritmo evolutivo, estos individuos representan una configuración de semáforos para todo el Corredor Garzón, que incluye la duración de las fases y el \emph{offset}. Luego por cada individuo se genera un archivo compatible con el simulador, que representa la configuración de semáforos. Este archivo se utiliza como entrada para ejecutar el simulador. Al finalizar la ejecución se generan archivos de salida que son procesados por el algoritmo evolutivo. Los datos de salida incluyen información necesaria para calcular el \emph{fitness} de cada individuo como la velocidad media de ómnibus y otros vehículos. El algoritmo se detiene al alcanzar un número de generaciones determinado, en ese momento se crea un archivo con la mejor configuración de semáforos encontrada. 

\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{Figures/arquitectura1}
	\caption{Arquitectura de la función de fitness}
	\label{fig:arquitectura1}
\end{figure}

